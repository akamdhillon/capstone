version: '3.8'

# =============================================================================
# CLARITY+ SMART MIRROR - DOCKER COMPOSE CONFIGURATION
# =============================================================================
# Network topology:
#   - RPi (192.168.10.1): Runs api-gateway + frontend-ui
#   - Jetson (192.168.10.2): Runs jetson-ml (GPU inference)
#
# Bridge network 'clarity-bridge' enables inter-container communication
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # RASPBERRY PI SERVICES (Node: 192.168.10.1)
  # ---------------------------------------------------------------------------

  api-gateway:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: clarity_backend
    hostname: rpi-gateway
    ports:
      - "8000:8000"
    environment:
      - JETSON_IP=192.168.10.2
      - THERMAL_ENABLED=${THERMAL_ENABLED:-false}
      - DATABASE_URL=sqlite:///data/clarity.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./backend/data:/app/data
      - backend_logs:/app/logs
    networks:
      clarity-bridge:
        ipv4_address: 172.20.0.10
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M

  frontend-ui:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: clarity_ui
    hostname: rpi-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://192.168.10.1:8000
      - NODE_ENV=${NODE_ENV:-development}
    networks:
      clarity-bridge:
        ipv4_address: 172.20.0.11
    depends_on:
      api-gateway:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M

  # ---------------------------------------------------------------------------
  # JETSON NANO SERVICES (Node: 192.168.10.2)
  # ---------------------------------------------------------------------------

  jetson-ml:
    build:
      context: ./jetson
      dockerfile: Dockerfile
    container_name: clarity_ml
    hostname: jetson-inference
    # NVIDIA runtime for GPU passthrough - critical for TensorRT inference
    runtime: ${DOCKER_RUNTIME:-nvidia}
    ports:
      - "8001:8001"  # Face Recognition Service
      - "8002:8002"  # Skin Analysis Service
      - "8003:8003"  # Posture Detection Service
      - "8004:8004"  # Eye Strain Service
      - "8005:8005"  # Thermal Service (conditional)
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      - ENABLE_THERMAL=${THERMAL_ENABLED:-false}
      - DEV_MODE=${DEV_MODE:-false}
      - CAMERA_DEVICE=${CAMERA_DEVICE:-/dev/video0}
      - RPI_GATEWAY_IP=192.168.10.1
      - MODEL_PRECISION=${MODEL_PRECISION:-FP16}
    volumes:
      - ./jetson/models:/app/models:ro
      - ./test_media:/app/test_media:ro
      - /tmp/argus_socket:/tmp/argus_socket  # Camera access
    devices:
      - /dev/video0:/dev/video0  # USB camera passthrough
    networks:
      clarity-bridge:
        ipv4_address: 172.20.0.20
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================
# Bridge network for inter-container communication
# Physical nodes communicate via Ethernet bridge (192.168.10.x)
# =============================================================================

networks:
  clarity-bridge:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1

# =============================================================================
# PERSISTENT VOLUMES
# =============================================================================

volumes:
  backend_logs:
    driver: local
